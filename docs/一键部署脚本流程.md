
# 一键部署需求清单（简约 · 美观 · 全中文释义）

## 一、交互规范

### 1. 菜单（墨绿色）
- 样式：菜单项用墨绿色文字显示。  
- 示例：  
```
请选择安装模式（输入数字 1/2/3）：
1) 全新安装（删除旧版并备份后重装）
2) 覆盖安装（保留数据，只更新代码结构） ← 推荐
3) 升级安装（仅同步差异文件）
```

### 2. 进度条（灰蓝色）
- 样式：灰蓝背景，带百分比与描述。  
- 示例：  
```
｜░░░░░░░░░                        ｜40% 正在拉取仓库代码...
｜░░░░░░░░░░░░░░░░░                ｜70% 正在启动容器...
｜░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░｜100% 部署完成！
```

### 3. 报错与警告（红色）
- 样式：红色文字块，显示错误详情。  
- 示例：  
```
✘ 错误（行号:84，退出码:1）
---- 建议操作 ----
日志调取命令：tail -n 200 /var/log/minipost/deploy.latest.log
```

### 4. 日志输出（浅灰色，限制 5 行）
- 样式：仅显示最后 5 行，顶部/底部分隔线。  
- 示例：  
```
--------------------
compose-web  Built
Network compose_default  Created
Container compose-postgres-1  Starting
Container compose-postgres-1  Error
dependency failed to start...
--------------------
```

---

## 二、部署流程步骤

1. **日志与审计**：全程记录，报错显示日志命令。  
2. **依赖与 Docker**：安装/更新 `git`、`curl`、`docker`、`compose`。  
3. **仓库与配置**：拉取/更新代码，校验 `.deploy.env` 与 Compose 文件。  
4. **二次覆盖策略（菜单选择 1/2/3）**  
   - 1 = 全新安装：备份 → 删除旧版 → 重装  
   - 2 = 覆盖安装：保留数据卷，只更新结构（默认）  
   - 3 = 升级安装：仅应用差异文件  
5. **性能优化**：ZRAM/Swap、关闭 THP、启用 BBR、提升 ulimit、Docker 日志轮转。  
6. **安全基线**：UFW 自动放行端口，Fail2ban/自动更新可选。  
7. **Compose 编排**：启动容器并健康检查。  
8. **数据库迁移**  
   - 全新安装 → 强制迁移  
   - 覆盖安装 → 自动迁移  
   - 升级安装 → 默认跳过，日志提示  
9. **管理员初始化（强制输入账号/密码）**：写入数据库，确保能登录。  
10. **链路验证**：`curl` 本地与公网 `/healthz` 返回 200。  
11. **部署包裹（最终报告）** 打印：  
    - 安装模式、时间、Git 版本号  
    - 公网 IP、访问地址  
    - 管理员账号  
    - 容器状态（`docker compose ps`）  
    - 数据/日志目录  
    - 常用日志命令  
12. **重启所有服务**
13. **失败回滚**：出错时自动恢复最近备份，并打印错误详情 + 日志命令。  

---

## 三、最终效果

- 部署过程有 **灰蓝色进度条**，清晰显示百分比与当前任务。  
- 菜单选项为 **墨绿色**，直观提示操作模式。  
- 报错为 **红色**，立即显示日志命令，避免排查困难。  
- 日志展示为 **浅灰色 5 行窗口**，不刷屏。  
- 最后输出 **部署包裹**，集中打印公网 IP、账号、访问地址、容器状态与日志命令。  
