<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>模板编辑器 · ChatGPT 主题（白）</title>

  <style>
    /* =========================================================
     * 设计系统（全部可调参数 / 与现有风格兼容）
     * 说明：只改变量即可统一换肤；不破坏你现有按钮/逻辑。
     * ========================================================= */
    :root{
      /* 品牌与语义色（ChatGPT 绿色为主色） */
      --brand: #10a37f;            /* 主色：ChatGPT 绿 */
      --brand-ink:#0b8a6b;        /* 主色按压/深色 */
      --text: #0f172a;            /* 正文文字 */
      --muted:#6b7280;            /* 次级文字 */
      --line:#e5e7eb;             /* 细分隔线 */

      /* 背景与卡片 */
      --page-bg:#ffffff;          /* 页面背景（纯白） */
      --card-bg:#ffffff;          /* 卡片背景（纯白） */
      --card-radius:12px;         /* 卡片圆角 */
      --shadow:0 6px 24px rgba(0,0,0,.06); /* 柔和阴影 */

      /* 布局尺寸（满足“95% 宽度”） */
      --wrap-w:95%;               /* 主体容器宽度占比 */
      --wrap-max:1600px;          /* 最大宽度（可调） */
      --gap:14px;                 /* 栅格间距 */
      --section-pt:14px;          /* 区块上边距 */

      /* 编辑区尺寸 */
      --editor-h:clamp(420px, 66vh, 840px); /* 左右编辑/预览高度 */
      --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* ========== 全局基础 ========== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--page-bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit; text-decoration:none}
    .hidden{display:none!important}

    /* ========== 一级导航（保留你原有 _nav.html，Tabs 为二级条） ========== */
    .subnav{position:sticky; top:0; z-index:8; background:var(--page-bg); border-bottom:1px solid var(--line)}
    .subnav .inner{width:var(--wrap-w); max-width:var(--wrap-max); margin:0 auto; display:flex; align-items:center; gap:12px; height:56px}
    .subnav .tabs{display:flex; gap:8px}
    .subnav .tab{position:relative; display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 14px; border-radius:999px; border:1px solid var(--line); background:#fff; font-weight:600; font-size:14px}
    .subnav .tab.active{background:var(--brand); color:#fff; border-color:transparent; box-shadow:0 2px 10px rgba(16,163,127,.25)}

    /* ========== 白色主图（简洁白卡 + 轻微线性纹理，贯彻 ChatGPT 极简风） ========== */
    .hero{width:var(--wrap-w); max-width:var(--wrap-max); margin:14px auto;}
    .hero .card{background:var(--card-bg); border:1px solid var(--line); border-radius:var(--card-radius); box-shadow:var(--shadow); padding:18px; display:flex; align-items:center; gap:16px}
    .hero .illu{width:84px; aspect-ratio:1; border-radius:16px; border:1px solid var(--line); background:#fff; display:grid; place-items:center}
    /* 简易 SVG 抽象图形（白底、绿色线稿），作为“白色主图”占位 */
    .hero svg{width:56px; height:56px}
    .hero .txt h1{margin:0 0 6px; font-size:18px}
    .hero .txt p{margin:0; color:var(--muted); font-size:13px}

    /* ========== 主体容器（满足“95% 宽度”） ========== */
    .section{width:var(--wrap-w); max-width:var(--wrap-max); margin:0 auto; padding-top:var(--section-pt)}

    /* ========== 功能按钮条（仅样式，不改 DOM / 事件） ========== */
    .action-bar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-start; padding:10px; border:1px dashed var(--line); border-radius:10px; background:#fff; margin-bottom:12px}
    .action-bar .btn, .action-bar button, .action-bar input[type=submit]{height:34px; padding:0 12px; border-radius:8px; border:1px solid var(--line); background:#fff}
    .action-bar .btn.primary, .action-bar .btn-save{background:var(--brand); color:#fff; border-color:transparent}

    /* ========== 列表区（类型分组 + 中文命名/释义） ========== */
    .card{background:var(--card-bg); border:1px solid var(--line); border-radius:var(--card-radius); box-shadow:var(--shadow); padding:16px}
    .list-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
    .group{border:1px solid var(--line); border-radius:12px; margin:12px 0}
    .group-hd{display:flex; align-items:center; gap:8px; height:44px; padding:0 14px; border-bottom:1px solid var(--line); background:#fafafa; font-weight:700}
    .tpls{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; padding:12px}
    .tpl{border:1px solid var(--line); border-radius:10px; padding:12px; background:#fff; display:grid; grid-template-columns:1fr auto; grid-template-areas:
      "title ops" "meta ops" "desc ops"; gap:6px}
    .tpl .title{grid-area:title; font-weight:700}
    .tpl .meta{grid-area:meta; color:var(--muted); font-size:12px}
    .tpl .desc{grid-area:desc; color:#374151; font-size:13px}
    .tpl .ops{grid-area:ops; display:flex; flex-direction:column; gap:6px; align-items:flex-end}
    .tpl .ops .btn{height:30px; padding:0 10px; border-radius:8px; border:1px solid var(--line); background:#fff; font-size:12px}
    .tpl .ops .btn.ghost{background:#fff}

    .empty{padding:12px; color:var(--muted); font-size:13px}

    /* ========== 编辑区（左右 1:1 比例） ========== */
    .head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .path{color:var(--muted); font-size:12px}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
    .pane{display:flex; flex-direction:column; min-height:var(--editor-h)}
    .pane label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .code textarea{
      flex:1; width:100%; min-height:var(--editor-h); resize:vertical; padding:12px; border:1px solid var(--line);
      border-radius:10px; font:13px/1.5 var(--mono); outline:none; background:#fff;
    }
    .preview iframe{flex:1; width:100%; min-height:var(--editor-h); border:1px solid var(--line); border-radius:10px; background:#fff}
    .jinja-hint{margin-top:6px; color:var(--muted); font-size:12px}

    /* ========== 响应式 ========== */
    @media (max-width: 1100px){
      .tpls{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  {# =========================================================
     全局导航（保持你的原有导航 _nav.html）
     说明：Tabs 为“一级导航下的二级条”，不替换你原主导航。
     ========================================================= #}
  {% include "_nav.html" %}
  <nav class="subnav" aria-label="模板编辑器导航">
    <div class="inner">
      <div class="tabs" role="tablist">
        <a href="#" id="tab-list" class="tab" role="tab" aria-controls="panel-list">模版列表</a>
        <a href="#" id="tab-edit" class="tab" role="tab" aria-controls="panel-edit">模版编辑</a>
      </div>
    </div>
  </nav>

  {# =========================================================
     顶部白色主图（ChatGPT 风格极简白卡）
     ========================================================= #}
  <section class="hero">
    <div class="card">
      <div class="illu" aria-hidden="true">
        <!-- 简洁抽象 Logo（白底 + ChatGPT 绿描边），无外链图片，安全可离线 -->
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="ChatGPT 主题白色主图">
          <path d="M24 6c-5 0-9 4-9 9 0 .6.05 1.2.15 1.76-3.15.8-5.5 3.67-5.5 7.09 0 4.04 3.27 7.31 7.31 7.31h1.04c1.1 3.6 4.45 6.24 8.4 6.24 5 0 9-4 9-9 0-.57-.05-1.13-.16-1.67C38.3 25.9 41 22.9 41 19.24 41 14.98 37.56 11.8 33.4 11.8c-.7 0-1.39.08-2.04.24C30.37 8.7 27.46 6 24 6Z" stroke="var(--brand)" stroke-width="2"/>
        </svg>
      </div>
      <div class="txt">
        <h1>模板编辑器 · ChatGPT 主题（白）</h1>
        <p>极简、流畅、专业。列表与编辑均占页面宽度的 95%，编辑区左右 1:1 分栏。</p>
      </div>
    </div>
  </section>

  {# =========================================================
     模板列表（类型分组 / 中文命名 / 中文释义）
     说明：请后端传入 templates 列表（字段建议：type, name, cn, path, desc_cn, preview_url）。
     ========================================================= #}
  <section id="panel-list" class="section" role="tabpanel" aria-labelledby="tab-list">
    <div class="card">
      <div class="list-head">
        <h2 style="margin:0">模板列表</h2>
        <div class="muted" style="color:var(--muted);font-size:13px">按类型分组展示；点击“编辑”进入编辑页签。</div>
      </div>

      {% if templates is defined and templates %}
        {% for group in templates|groupby('type') %}
          <div class="group">
            <div class="group-hd">{{ group.grouper or '未分组' }}</div>
            <div class="tpls">
              {% for t in group.list %}
                <div class="tpl">
                  <div class="title">{{ t.cn or t.name or t.path }}</div>
                  <div class="meta"><code>{{ t.path }}</code></div>
                  <div class="desc">{{ t.desc_cn or t.desc or '（用途：请在后台补充说明）' }}</div>
                  <div class="ops">
                    <a class="btn" href="?path={{ (t.path|string)|urlencode }}" title="编辑该模板">编辑</a>
                    {% if t.preview_url %}
                      <a class="btn ghost" href="{{ t.preview_url }}" target="_blank" rel="noopener">预览</a>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty">暂无模板数据。请在后端传入 <code>templates</code> 列表（含字段：<code>type/name/cn/path/desc_cn/preview_url</code>）。</div>
      {% endif %}
    </div>
  </section>

  {# =========================================================
     模板编辑（左右 1:1；功能按钮保持不变）
     说明：保留你的按钮 DOM 与行为，仅统一外观；不更改提交/保存逻辑。
     ========================================================= #}
  <section id="panel-edit" class="section hidden" role="tabpanel" aria-labelledby="tab-edit">
    <div class="card">
      <div class="head">
        <h2 style="margin:0">模板编辑</h2>
        <div class="path">当前文件：<code>{{ path or '未选择' }}</code></div>
      </div>

      <div id="actionBar" class="action-bar" data-keep="1">
        <!-- 功能按钮区域（保持不变）：
             1) 如果你的项目已有按钮局部模板，请保留以下 include（自动载入，无则忽略）。
             2) 如果按钮写在本文件旧版中，请把原 DOM 整段粘贴回此容器内；样式会自动套用。 -->
        {% include "editor/_actions.html" ignore missing %}
        {% include "_editor_actions.html" ignore missing %}
      </div>

      <div class="split">
        <!-- 左：代码编辑（支持 HTML/CSS/JS；Jinja 标签将按文本显示） -->
        <div class="pane code">
          <label for="code">代码</label>
          <form id="editForm" method="post" action="{{ save_url or '/editor/save' }}">
            <input type="hidden" name="path" value="{{ path or '' }}" />
            <textarea id="code" name="code" spellcheck="false" placeholder="在此粘贴或编辑你的模板代码（HTML/CSS/JS）。">{{ code|default('', true)|e }}</textarea>
          </form>
        </div>

        <!-- 右：实时预览（静态 HTML 预览；不渲染后端模板变量） -->
        <div class="pane preview">
          <label>预览</label>
          <iframe id="live" title="Live Preview"></iframe>
          <div class="jinja-hint">⚠️ 提示：Jinja 模板变量/指令不会在此处渲染；此处仅做静态 HTML 预览。</div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // =========================================================
    // 交互脚本（零依赖，确保离线可用）
    // - Tabs 切换（模版列表 / 模版编辑）
    // - 代码实时预览（200ms 防抖）
    // - Ctrl/Cmd + S 触发保存（不改你原按钮，仅提供快捷键兜底）
    // =========================================================

    // —— Tabs 切换 ——
    const tabList  = document.getElementById('tab-list');
    const tabEdit  = document.getElementById('tab-edit');
    const panelList= document.getElementById('panel-list');
    const panelEdit= document.getElementById('panel-edit');

    function activate(which){
      if(which==='list'){
        tabList.classList.add('active'); tabList.setAttribute('aria-selected','true');
        tabEdit.classList.remove('active'); tabEdit.removeAttribute('aria-selected');
        panelList.classList.remove('hidden'); panelEdit.classList.add('hidden');
      }else{
        tabEdit.classList.add('active');  tabEdit.setAttribute('aria-selected','true');
        tabList.classList.remove('active'); tabList.removeAttribute('aria-selected');
        panelEdit.classList.remove('hidden'); panelList.classList.add('hidden');
        // 进入编辑页签后，刷新一次预览
        setTimeout(refreshPreview, 0);
      }
    }
    tabList && tabList.addEventListener('click',e=>{e.preventDefault();activate('list')});
    tabEdit && tabEdit.addEventListener('click',e=>{e.preventDefault();activate('edit')});

    // 默认页签：若已有 path 则直接进入“模板编辑”
    {% if path %}activate('edit');{% else %}activate('list');{% endif %}

    // —— 预览逻辑：把 <textarea> 内容写入 <iframe> ——
    const TA = document.getElementById('code');
    const IF = document.getElementById('live');

    function buildPreviewHTML(src){
      // 若用户粘贴的不是完整 HTML，而是片段（如仅 <div>…），自动包一层最小 HTML 框架
      const looksLikeFull = /<html[\s\S]*><\/html>/i.test(src);
      if(looksLikeFull) return src;
      return `<!doctype html>\n<html lang=\"zh-CN\">\n<head>\n<meta charset=\"utf-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<title>预览</title>\n<style>html,body{height:100%}body{margin:0;padding:16px;font:14px/1.6 -apple-system,system-ui,Segoe UI,PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;color:#0f172a}*,*::before,*::after{box-sizing:border-box}</style>\n</head>\n<body>\n${src}\n</body>\n</html>`;
    }

    function refreshPreview(){
      if(!IF) return;
      const doc = IF.contentDocument || IF.contentWindow?.document; if(!doc) return;
      const html = TA ? buildPreviewHTML(TA.value) : '<!doctype html><title>空</title>';
      doc.open(); doc.write(html); doc.close();
    }

    let pid=null; function debouncedPreview(){ if(!IF) return; clearTimeout(pid); pid=setTimeout(refreshPreview,200) }
    if(TA && IF){ refreshPreview(); TA.addEventListener('input', debouncedPreview); }

    // —— 快捷键：Ctrl/Cmd + S 提交（优先触发你原有“保存”按钮） ——
    window.addEventListener('keydown', (e)=>{
      const isSave = (e.key==='s'||e.key==='S') && (e.ctrlKey||e.metaKey);
      if(!isSave) return;
      e.preventDefault();
      // 优先寻找你项目里的保存按钮（常见选择器），否则兜底提交表单
      const btn = document.querySelector('#actionBar [data-role="save"], #actionBar .btn-save, #actionBar [type="submit"]');
      if(btn) btn.click(); else document.getElementById('editForm')?.submit();
    });
  </script>
</body>
</html>
