const track=document.getElementById('navTrack'); const pill=document.getElementById('pill'); const subInner=document.getElementById('subInner'); const tabsEl=document.getElementById('tabs'); const tabCard=document.getElementById('tabCard'); const tabPanel=document.getElementById('tabPanel');
let L1=[], L2={}, L3={}; let links=[]; let lockedPath="", lockedSubHref="", lockedTabHref="";
function h(el,cls){const e=document.createElement(el); if(cls) e.className=cls; return e;}
function movePillToEl(el){ if(!el){pill.style.opacity=0;return;} const left=el.offsetLeft-track.scrollLeft; const minw=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pill-minw'))||60; const width=Math.max(minw,el.offsetWidth); pill.style.width=width+'px'; pill.style.transform=`translate(${left}px,-50%)`; pill.style.opacity=1; }
function renderL1(){ track.querySelectorAll('a.link').forEach(a=>a.remove()); L1.sort((a,b)=>(a.order??999)-(b.order??999)||a.text.localeCompare(b.text)); L1.forEach(it=>{ const a=h('a','link'); a.href=it.href; a.dataset.path=it.href; a.textContent=it.text; track.appendChild(a); }); links=[...track.querySelectorAll('.link')]; if(!lockedPath) lockedPath=(L1[0]&&L1[0].href)||""; highlightActive(); movePillToEl(links.find(a=>a.dataset.path===lockedPath)); links.forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); lockedPath=a.dataset.path; renderSub(); highlightActive(); })); }
function highlightActive(){ links.forEach(a=>a.classList.toggle('active',a.dataset.path===lockedPath)); }
function renderSub(){ const list=(L2[lockedPath]||[]).slice().sort((a,b)=>(a.order??999)-(b.order??999)); subInner.innerHTML=list.map(i=>`<a class="sub ${i.href===lockedSubHref?'active':''}" data-owner="${lockedPath}" href="${i.href}" ${i.disabled?'aria-disabled="true"':''}>${i.text}</a>`).join(''); if(list.length){ lockedSubHref=list.some(x=>x.href===lockedSubHref)?lockedSubHref:list[0].href; } subInner.querySelectorAll('a.sub').forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); lockedSubHref=a.getAttribute('href'); renderTabs(); })); renderTabs(); }
function ensureTabInk(){ let ink=document.getElementById('tabInk'); if(!ink){ ink=h('span','tab-ink'); ink.id='tabInk'; tabsEl.appendChild(ink);} return ink; }
function positionTabInk(activeTabEl=null,animate=false){ const ink=ensureTabInk(); const a=activeTabEl||tabsEl.querySelector('.tab.active'); if(!a){ ink.style.width='0px'; return; } const txt=a.querySelector('.tab__text')||a; const rect=txt.getBoundingClientRect(); const tabsRect=tabsEl.getBoundingClientRect(); const padX=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tab-ink-pad-x'))||0; const ml=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tab-ink-ml'))||0; const left=Math.round(rect.left-tabsRect.left+ml); const width=Math.max(2,Math.round(rect.width+padX*2)); const prev=ink.style.transition; if(!animate){ ink.style.transition='none'; } ink.style.width=width+'px'; ink.style.transform=`translateX(${left}px)`; if(!animate){ void ink.offsetWidth; ink.style.transition=prev||''; } }
function renderTabs(){ const list=(L3[lockedSubHref]||[]).slice().sort((a,b)=>(a.order??999)-(b.order??999)); if(!list.length){ tabsEl.innerHTML=''; ensureTabInk(); tabCard.classList.add('no-tabs'); tabPanel.innerHTML='该二级暂无页签内容。'; return; } if(!lockedTabHref||!list.some(t=>t.href===lockedTabHref)){ lockedTabHref=list[0].href; } tabsEl.innerHTML=list.map(t=>`<a class="tab ${t.href===lockedTabHref?'active':''}" data-sub="${lockedSubHref}" data-key="${t.key||''}" href="${t.href}"><span class="tab__text">${t.text}</span></a>`).join(''); tabsEl.querySelectorAll('.tab').forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); tabsEl.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); a.classList.add('active'); lockedTabHref=a.getAttribute('href'); positionTabInk(a,true); tabCard.classList.remove('no-tabs'); tabPanel.innerHTML=`当前：<strong>${lockedSubHref}</strong> &rsaquo; <strong>${a.textContent}</strong>`; })); positionTabInk(tabsEl.querySelector('.tab.active'),false); tabCard.classList.remove('no-tabs'); tabPanel.innerHTML=`当前：<strong>${lockedSubHref}</strong> &rsaquo; <strong>${list.find(t=>t.href===lockedTabHref)?.text||''}</strong>`; }
async function initProfile(){ try{ const r=await fetch('/api/v1/shell/profile'); const j=await r.json(); const avatar=document.getElementById('avatar'); if(j && j.authenticated){ avatar.title=j.name||''; avatar.href='/logout'; avatar.addEventListener('click', async (e)=>{ e.preventDefault(); await fetch('/logout',{method:'POST'}); location.href='/login'; }); } else { avatar.title='登录'; avatar.href='/login'; } }catch(e){} }
async function initNav(){ try{ const r=await fetch('/api/v1/shell/nav'); const nav=await r.json(); L1=nav.l1||[]; L2=nav.l2||{}; L3=nav.l3||{}; }catch(e){ L1=[{key:'settings',text:'设置',href:'/settings',order:90}]; L2={'/settings':[ {text:'账号与权限',href:'/settings/rbac',order:10} ]}; L3={}; } renderL1(); renderSub(); }
window.addEventListener('resize', ()=> positionTabInk(tabsEl.querySelector('.tab.active'), false));
(function init(){ initProfile(); initNav(); })();
